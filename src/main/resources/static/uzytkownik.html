<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Twoja strona główna!</title>
</head>
<body>
  <h1>Twoja strona <span id="display"> </span></h1>
  <h2>Twoje przeczytanie ksiazki</h2>
  <p><a href="dodajRecenzje.html" style="color: red; font-weight: bold;">Dodaj książkę</a></p>
  <table id="tabela">
      <thead>
      <tr>
          <th>ID</th>
          <th>Tytuł</th>
          <th>Ocena</th>
      </tr>
      </thead>
  </table>


<script>
  async function getUsernameFromSession()
  {
      const response = await fetch('http://localhost:8080/api/uzytkownicy/ktoZalogowany',
          {
              credentials: 'include'
          });
      if (!response.ok) {
          return "Nie zalogowano!";
      }
      const data = await response.text();
      return data;
  }
  async function zaladujKsiazki(username) {


      const display = document.getElementById('display');
      display.textContent = username;
      try {
          const response = await fetch('http://localhost:8080/api/przeczytane/uzytkownik/username/' + username);
          if (!response.ok) {
              throw new Error("blad pobierana danych");
          }
          const data = await response.json();
          const tabela = document.getElementById('tabela');
          data.forEach(item => {
              const row = document.createElement('tr');
              const idCell = document.createElement('td');
              const titleCell = document.createElement('td');
              const ratingCell = document.createElement('td');
              idCell.textContent = item.ksiazkaId;
              titleCell.textContent = item.ksiazkaTytul;
              ratingCell.textContent = item.ocena ?? "Brak oceny";

              row.appendChild(idCell);
              row.appendChild(titleCell);
              row.appendChild(ratingCell);
              tabela.appendChild(row);


          })
      } catch (error) {
          console.log(error);
          const blad = document.createElement('p');
          blad.style.color = 'red';
          blad.textContent = 'Nie udało się załadować danych użytkownika.';
          document.body.appendChild(blad);
      }
  }
getUsernameFromSession().then(username =>
    {
        if(username != "Nie zalogowano!") {
            zaladujKsiazki(username);
        }
        else
        {
            const info = document.createElement('p');
            info.style.color = "red";
            info.textContent = "Nie zalogowano!";
            document.body.appendChild(info);
        }
    }
);


</script>

</body>
</html>